#!/bin/bash
# Start the gui and back-end in any case
# might ask to type password become root

. /etc/odemis.conf

export PYTHONPATH

# kill the GUI if it's already there
if pgrep -f $GUI > /dev/null; then
    echo "Found the GUI still running, killing it first..."
    pkill -f $GUI
fi

# start the backend if not available
odemis-cli --check
status=$?
if [ $status -ne 0 ]; then
    # backend not responding or dead
    if [ $status -gt 2 ]; then
        echo "Warning: failed to check status of back-end"
    fi
    
    # install cgroup, for memory protection
    if [ ! -d /sys/fs/cgroup/memory/odemisd -a -x /usr/bin/cgcreate ]; then
        echo "Creating cgroup"
        sudo /usr/bin/cgcreate -a :odemis -g memory:odemisd
    fi
    
    # kill the current backend
    sudo pkill -f $BACKEND

    # start a new one
    echo -n "Starting back-end.."
    # use sudo background mode to be sure it won't be killed at the end
    sudo -b odemisd --daemon --log-level=2 --log-target "$LOGFILE" "$MODEL"
    status=$?
    if [ $status -ne 0 ]; then
        echo " failed"
        exit 1
    fi
    
    # For Clara, initialisation can be pretty long
    echo -n ". "
    sleep 5
    
    # Check (and synchronise)
    if odemis-cli --check; then
        echo "done"
    else
        echo "failed"
        grep "ERROR" "$LOGFILE" | tail -n 30
	echo "For more log message see file $LOGFILE"
	read -p "Press [Enter] to quit..."
        exit 1
    fi
fi

# start the GUI
odemis-gui
